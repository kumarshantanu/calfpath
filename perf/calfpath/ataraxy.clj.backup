(defmacro fnrp
  [params]
  (i/expected vector? "params vector" params)
  `(fn [{{:keys ~params} :route-params}]
     (p-handler ~params)))


(def handler-ataraxy
 (ataraxy/handler
   {:routes '{"/v2/whoami"                                                   {:get [:handler]}
;              ["/v2/users/" user-id "/datasets"                            ] {:get [:h-user-id user-id]}
              ["/v2/public/projects/" project-id "/datasets"               ] {:get [:h-project-id project-id]}
              ["/v1/public/topics/" topic                                  ] {:get [:h-topic topic]}
              ["/v1/users/" user-id "/orgs/" org-id                        ] {:get [:h-user-id-org-id user-id org-id]}
              ["/v1/search/topics/" term                                   ] {:get [:h-term term]}
              ["/v1/users/" user-id "/invitations"                         ] {:get [:h-user-id user-id]}
;              ["/v1/orgs/" org-id "/devices/" batch "/" type               ] {:get [:h-org-id-batch-type org-id batch type]}
;              ["/v1/users/" user-id "/topics"                              ] {:get [:h-user-id user-id]}
;              ["/v1/users/" user-id "/bookmarks/followers"                 ] {:get [:h-user-id user-id]}
;              ["/v2/datasets/" dataset-id                                  ] {:get [:h-dataset-id dataset-id]}
;              ["/v1/orgs/" org-id "/usage-stats"                           ] {:get [:h-org-id org-id]}
;              ["/v1/messages/user/" user-id                                ] {:get [:h-user-id user-id]}
;              ["/v1/orgs/" org-id "/devices/" client-id                    ] {:get [:h-org-id-client-id org-id client-id]}
;              ["/v1/users/" user-id "/devices"                             ] {:get [:h-user-id user-id]}
;              ["/v1/public/users/" user-id                                 ] {:get [:h-user-id user-id]}
;              ["/v1/orgs/" org-id "/errors"                                ] {:get [:h-org-id org-id]}
;              ["/v1/public/orgs/" org-id                                   ] {:get [:h-org-id org-id]}
;              ["/v1/orgs/" org-id "/invitations"                           ] {:get [:h-org-id org-id]}
;              ;;"/v2/public/messages/dataset/bulk"                             {:get [:handler]}
;              ;;["/v1/users/" user-id "/devices/bulk"                        ] {:get [:h-user-id user-id]}
;              ["/v1/users/" user-id "/device-errors"                       ] {:get [:h-user-id user-id]}
;              "/v2/login"                                                    {:get [:handler]}
;              ["/v1/users/" user-id "/usage-stats"                         ] {:get [:h-user-id user-id]}
;              ["/v2/users/" user-id "/devices"                             ] {:get [:h-user-id user-id]}
;              ["/v1/users/" user-id "/claim-device/" client-id             ] {:get [:h-user-id-client-id user-id client-id]}
;              ["/v2/public/projects/" project-id                           ] {:get [:h-project-id project-id]}
;              ["/v2/public/datasets/" dataset-id                           ] {:get [:h-dataset-id dataset-id]}
;              ;;["/v2/users/" user-id "/topics/bulk"                         ] {:get [:h-user-id user-id]}
;              ["/v1/messages/device/" client-id                            ] {:get [:h-client-id client-id]}
;              ["/v1/users/" user-id "/owned-orgs"                          ] {:get [:h-user-id user-id]}
;              ["/v1/topics/" topic                                         ] {:get [:h-topic topic]}
;              ["/v1/users/" user-id "/bookmark/" topic                     ] {:get [:h-user-id-topic user-id topic]}
;              ["/v1/orgs/" org-id "/members/" user-id                      ] {:get [:h-org-id-user-id org-id user-id]}
;              ["/v1/users/" user-id "/devices/" client-id                  ] {:get [:h-user-id-client-id user-id client-id]}
;              ["/v1/users/" user-id                                        ] {:get [:h-user-id user-id]}
;              ["/v1/orgs/" org-id "/devices"                               ] {:get [:h-org-id org-id]}
;              ["/v1/orgs/" org-id "/members"                               ] {:get [:h-org-id org-id]}
;              ["/v1/orgs/" org-id "/members/invitation-data/" user-id      ] {:get [:h-org-id-user-id org-id user-id]}
;              ["/v2/orgs/" org-id "/topics"                                ] {:get [:h-org-id org-id]}
;              "/v1/whoami"                                                   {:get [:handler]}
;              ["/v1/orgs/" org-id                                          ] {:get [:h-org-id org-id]}
;              ["/v1/users/" user-id "/api-key"                             ] {:get [:h-user-id user-id]}
;              "/v2/schemas"                                                  {:get [:handler]}
;              ["/v2/users/" user-id "/topics"                              ] {:get [:h-user-id user-id]}
;              ["/v1/orgs/" org-id "/confirm-membership/" token             ] {:get [:h-org-id-token org-id token]}
;              ["/v2/topics/" topic                                         ] {:get [:h-topic topic]}
;              ["/v1/messages/topic/" topic                                 ] {:get [:h-topic topic]}
;              ["/v1/users/" user-id "/devices/" client-id "/reset-password"] {:get [:h-user-id-client-id user-id client-id]}
;              "/v2/topics"                                                   {:get [:handler]}
;              "/v1/login"                                                    {:get [:handler]}
;              ["/v1/users/" user-id "/orgs"                                ] {:get [:h-user-id user-id]}
;              ["/v2/public/messages/dataset/" dataset-id                   ] {:get [:h-dataset-id dataset-id]}
;              "/v1/topics"                                                   {:get [:handler]}
;              "/v1/orgs"                                                     {:get [:handler]}
;              ["/v1/users/" user-id "/bookmarks"                           ] {:get [:h-user-id user-id]}
              ["/v1/orgs/" org-id "/topics"                                ] {:get [:h-org-id org-id]}}
    :handlers {:handler             handler
               :h-user-id           (fnrp [user-id])
               :h-project-id        (fnrp [project-id])
               :h-topic             (fnrp [topic])
               :h-user-id-org-id    (fnrp [user-id org-id])
               :h-term              (fnrp [term])
               :h-org-id-batch-type (fnrp [org-id batch type])
               :h-dataset-id        (fnrp [dataset-id])
               :h-org-id            (fnrp [org-id])
               :h-org-id-client-id  (fnrp [org-id client-id])
               :h-user-id-client-id (fnrp [user-id client-id])
               :h-client-id         (fnrp [client-id])
               :h-user-id-topic     (fnrp [user-id topic])
               :h-org-id-user-id    (fnrp [org-id user-id])
               :h-org-id-token      (fnrp [org-id token])}}))
